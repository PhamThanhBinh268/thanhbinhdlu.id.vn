<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>Thanh Lý Đồ Cũ - Đăng Ký</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta
      content="Mua bán đồ cũ, trao đổi đồ cũ, thanh lý đồ cũ"
      name="keywords"
    />
    <meta
      content="Đăng ký để mua bán và trao đổi đồ cũ chất lượng, giá tốt tại Việt Nam"
      name="description"
    />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <!-- Shared Header Placeholder -->
    <div id="app-header"></div>

    <!-- Breadcrumb Start -->
    <div class="container-fluid">
      <div class="row px-xl-5">
        <div class="col-12">
          <nav class="breadcrumb bg-light mb-30">
            <a class="breadcrumb-item text-dark" href="#">Trang Chủ</a>
            <span class="breadcrumb-item active">Đăng Ký</span>
          </nav>
        </div>
      </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Signup Start -->
    <div class="container-fluid">
      <h2 class="section-title position-relative text-uppercase mx-xl-5 mb-4">
        <span class="bg-secondary pr-3">Đăng Ký</span>
      </h2>
      <div class="row px-xl-5">
        <div class="col-lg-6 mx-auto mb-5">
          <div class="bg-light p-30">
            <form id="signupForm" novalidate="novalidate">
              <div class="form-group">
                <label for="fullName">Họ và Tên</label>
                <input
                  type="text"
                  class="form-control"
                  id="fullName"
                  placeholder="Nguyễn Văn A"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  placeholder="vidu@email.com"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label for="phone">Số Điện Thoại</label>
                <input
                  type="text"
                  class="form-control"
                  id="phone"
                  placeholder="+84 123 456 789"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label for="address">Địa Chỉ</label>
                <input
                  type="text"
                  class="form-control"
                  id="address"
                  placeholder="Địa chỉ của bạn"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label for="password">Mật Khẩu</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  placeholder="Nhập mật khẩu (ít nhất 6 ký tự)"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label for="confirmPassword">Xác Nhận Mật Khẩu</label>
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  placeholder="Xác nhận mật khẩu"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input
                    type="checkbox"
                    class="custom-control-input"
                    id="terms"
                    required
                  />
                  <label class="custom-control-label" for="terms"
                    >Tôi đồng ý với
                    <a href="#" class="text-primary" id="termsLink"
                      >điều khoản và điều kiện</a
                    ></label
                  >
                </div>
                <div class="invalid-feedback"></div>
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3"
                id="signupBtn"
              >
                Đăng Ký
              </button>
              <div class="text-center mt-3">
                <a href="login.html" class="text-primary"
                  >Đã có tài khoản? Đăng nhập ngay</a
                >
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Signup End -->

    <!-- Shared Footer Placeholder -->
    <div id="app-footer"></div>

    <!-- Back to Top -->
    <a href="#" class="btn btn-primary back-to-top"
      ><i class="fa fa-angle-double-up"></i
    ></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="js/main.js"></script>
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>
    <!-- Signup Page Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const signupForm = document.getElementById("signupForm");
        const inputs = {
          fullName: document.getElementById("fullName"),
          email: document.getElementById("email"),
          phone: document.getElementById("phone"),
          address: document.getElementById("address"),
          password: document.getElementById("password"),
          confirmPassword: document.getElementById("confirmPassword"),
          terms: document.getElementById("terms"),
        };
        const signupBtn = document.getElementById("signupBtn");

        // Kiểm tra nếu đã đăng nhập
        if (AuthManager.isLoggedIn()) {
          window.location.href = "index.html";
          return;
        }

        signupForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          // Reset validation states
          clearValidationErrors();

          // Get form values
          const formData = {
            hoTen: inputs.fullName.value.trim(),
            email: inputs.email.value.trim(),
            soDienThoai: inputs.phone.value.trim(),
            diaChi: inputs.address.value.trim(),
            matKhau: inputs.password.value,
            xacNhanMatKhau: inputs.confirmPassword.value,
            dongYDieuKhoan: inputs.terms.checked,
          };

          // Validate form
          let hasError = false;

          // Validate họ tên
          if (!formData.hoTen || formData.hoTen.length < 2) {
            showValidationError(
              inputs.fullName,
              "Họ tên phải có ít nhất 2 ký tự"
            );
            hasError = true;
          }

          // Validate email
          if (!formData.email || !Utils.isValidEmail(formData.email)) {
            showValidationError(inputs.email, "Email không hợp lệ");
            hasError = true;
          }

          // Validate phone
          if (
            !formData.soDienThoai ||
            !Utils.isValidPhone(formData.soDienThoai)
          ) {
            showValidationError(inputs.phone, "Số điện thoại không hợp lệ");
            hasError = true;
          }

          // Validate address
          if (!formData.diaChi || formData.diaChi.length < 5) {
            showValidationError(
              inputs.address,
              "Địa chỉ phải có ít nhất 5 ký tự"
            );
            hasError = true;
          }

          // Validate password
          if (!formData.matKhau || formData.matKhau.length < 6) {
            showValidationError(
              inputs.password,
              "Mật khẩu phải có ít nhất 6 ký tự"
            );
            hasError = true;
          }

          // Validate confirm password
          if (formData.matKhau !== formData.xacNhanMatKhau) {
            showValidationError(
              inputs.confirmPassword,
              "Mật khẩu xác nhận không khớp"
            );
            hasError = true;
          }

          // Validate terms
          if (!formData.dongYDieuKhoan) {
            showValidationError(
              inputs.terms,
              "Bạn phải đồng ý với điều khoản và điều kiện"
            );
            hasError = true;
          }

          if (hasError) return;

          try {
            Utils.showLoading(signupBtn);

            // Prepare data for API
            const apiData = {
              hoTen: formData.hoTen,
              email: formData.email,
              soDienThoai: formData.soDienThoai,
              diaChi: formData.diaChi,
              matKhau: formData.matKhau,
              vaiTro: "user",
            };

            const response = await ApiService.post(
              API_CONFIG.ENDPOINTS.AUTH.REGISTER,
              apiData
            );

            // Lưu token và user info
            AuthManager.setToken(response.token);
            AuthManager.setUser(response.user);

            Utils.showToast(
              "Đăng ký thành công! Chào mừng bạn đến với Thanh Lý Đồ Cũ",
              "success"
            );

            // Redirect sau 2 giây
            setTimeout(() => {
              window.location.href = "index.html";
            }, 2000);
          } catch (error) {
            console.error("Signup error:", error);

            // Hiển thị lỗi cụ thể từ server
            if (error.message.includes("Email đã được sử dụng")) {
              showValidationError(inputs.email, "Email này đã được đăng ký");
            } else if (
              error.message.includes("Số điện thoại đã được sử dụng")
            ) {
              showValidationError(
                inputs.phone,
                "Số điện thoại này đã được đăng ký"
              );
            } else {
              Utils.showToast("Đăng ký thất bại: " + error.message, "error");
            }
          } finally {
            Utils.hideLoading(signupBtn);
          }
        });

        // Terms link handler
        document
          .getElementById("termsLink")
          .addEventListener("click", function (e) {
            e.preventDefault();
            showTermsModal();
          });

        function showValidationError(input, message) {
          input.classList.add("is-invalid");
          const feedback = input.parentNode.querySelector(".invalid-feedback");
          if (feedback) {
            feedback.textContent = message;
          }
        }

        function clearValidationErrors() {
          Object.values(inputs).forEach((input) => {
            input.classList.remove("is-invalid");
            const feedback =
              input.parentNode?.querySelector(".invalid-feedback");
            if (feedback) {
              feedback.textContent = "";
            }
          });
        }

        function showTermsModal() {
          const modal = document.createElement("div");
          modal.className = "modal fade";
          modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Điều Khoản và Điều Kiện</h5>
                                <button type="button" class="close" data-dismiss="modal">
                                    <span>&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <h6>1. Chấp nhận điều khoản</h6>
                                <p>Bằng cách sử dụng website này, bạn đồng ý tuân thủ các điều khoản và điều kiện sau.</p>
                                
                                <h6>2. Quyền và nghĩa vụ người dùng</h6>
                                <p>- Cung cấp thông tin chính xác khi đăng ký</p>
                                <p>- Không đăng nội dung vi phạm pháp luật</p>
                                <p>- Tôn trọng quyền lợi người dùng khác</p>
                                
                                <h6>3. Quy định về giao dịch</h6>
                                <p>- Người dùng chịu trách nhiệm về tính chính xác của thông tin sản phẩm</p>
                                <p>- Website chỉ đóng vai trò trung gian</p>
                                
                                <h6>4. Bảo mật thông tin</h6>
                                <p>Chúng tôi cam kết bảo vệ thông tin cá nhân của bạn theo quy định pháp luật.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">Đã hiểu</button>
                            </div>
                        </div>
                    </div>
                `;

          document.body.appendChild(modal);
          $(modal).modal("show");

          // Cleanup when modal is hidden
          $(modal).on("hidden.bs.modal", function () {
            modal.remove();
          });
        }
      });
    </script>
  </body>
</html>
