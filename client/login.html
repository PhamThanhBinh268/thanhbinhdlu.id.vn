<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>Thanh Lý Đồ Cũ - Đăng Nhập</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta
      content="Mua bán đồ cũ, trao đổi đồ cũ, thanh lý đồ cũ"
      name="keywords"
    />
    <meta
      content="Đăng nhập để mua bán và trao đổi đồ cũ chất lượng, giá tốt tại Việt Nam"
      name="description"
    />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body>
    <!-- Shared Header Placeholder -->
    <div id="app-header"></div>

    <!-- Breadcrumb Start -->
    <div class="container-fluid">
      <div class="row px-xl-5">
        <div class="col-12">
          <nav class="breadcrumb bg-light mb-30">
            <a class="breadcrumb-item text-dark" href="#">Trang Chủ</a>
            <span class="breadcrumb-item active">Đăng Nhập</span>
          </nav>
        </div>
      </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Login Start -->
    <div class="container-fluid">
      <h2 class="section-title position-relative text-uppercase mx-xl-5 mb-4">
        <span class="bg-secondary pr-3">Đăng Nhập</span>
      </h2>
      <div class="row px-xl-5">
        <div class="col-lg-6 mx-auto mb-5">
          <div class="bg-light p-30">
            <form id="loginForm" novalidate="novalidate">
              <div class="form-group">
                <label for="loginInput">Email hoặc Số Điện Thoại</label>
                <input
                  type="text"
                  class="form-control"
                  id="loginInput"
                  placeholder="vidu@email.com hoặc +84 123 456 789"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <label for="password">Mật Khẩu</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  placeholder="Nhập mật khẩu"
                  required
                />
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input
                    type="checkbox"
                    class="custom-control-input"
                    id="rememberMe"
                  />
                  <label class="custom-control-label" for="rememberMe"
                    >Ghi nhớ tôi</label
                  >
                </div>
              </div>
              <button
                type="submit"
                class="btn btn-primary btn-block py-3"
                id="loginBtn"
              >
                Đăng Nhập
              </button>
              <div class="text-center mt-3">
                <a href="signup.html" class="text-primary"
                  >Chưa có tài khoản? Đăng ký ngay</a
                >
              </div>
              <div class="text-center mt-2">
                <a href="#" class="text-primary" id="forgotPasswordLink"
                  >Quên mật khẩu?</a
                >
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Login End -->

    <!-- Shared Footer Placeholder -->
    <div id="app-footer"></div>

    <!-- Back to Top -->
    <a href="#" class="btn btn-primary back-to-top"
      ><i class="fa fa-angle-double-up"></i
    ></a>

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="js/main.js"></script>

    <!-- API + Layout (order: api, layout, page script) -->
    <script src="js/api.js"></script>
    <script src="js/layout.js"></script>

    <!-- Login Page Script -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const loginInput = document.getElementById("loginInput");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById("loginBtn");

        // Kiểm tra nếu đã đăng nhập
        if (AuthManager.isLoggedIn()) {
          window.location.href = "index.html";
          return;
        }

        loginForm.addEventListener("submit", async function (e) {
          e.preventDefault();

          const loginValue = loginInput.value.trim();
          const password = passwordInput.value.trim();

          // Reset validation states
          clearValidationErrors();

          // Validate inputs
          if (!loginValue) {
            showValidationError(
              loginInput,
              "Vui lòng nhập email hoặc số điện thoại"
            );
            return;
          }

          if (!password) {
            showValidationError(passwordInput, "Vui lòng nhập mật khẩu");
            return;
          }

          // Determine if input is email or phone
          let loginData = { matKhau: password };
          if (Utils.isValidEmail(loginValue)) {
            loginData.email = loginValue;
          } else if (Utils.isValidPhone(loginValue)) {
            // Chuẩn hóa bỏ +84 nếu user nhập dạng +84...
            let phone = loginValue.replace(/^\+84/, "0");
            loginData.soDienThoai = phone;
          } else {
            showValidationError(
              loginInput,
              "Email hoặc số điện thoại không hợp lệ"
            );
            return;
          }

          try {
            Utils.showLoading(loginBtn);

            const response = await ApiService.post(
              API_CONFIG.ENDPOINTS.AUTH.LOGIN,
              loginData
            );

            // Lưu token và user info
            AuthManager.setToken(response.token);
            AuthManager.setUser(response.user);

            Utils.showToast("Đăng nhập thành công!", "success");

            // Redirect sau 1 giây
            setTimeout(() => {
              const returnUrl =
                Utils.getQueryParam("returnUrl") || "index.html";
              window.location.href = returnUrl;
            }, 1000);
          } catch (error) {
            Utils.showToast(error.message, "error");
          } finally {
            Utils.hideLoading(loginBtn);
          }
        });

        // Forgot password handler
        document
          .getElementById("forgotPasswordLink")
          .addEventListener("click", function (e) {
            e.preventDefault();
            Utils.showToast("Tính năng quên mật khẩu đang phát triển", "info");
          });

        function showValidationError(input, message) {
          input.classList.add("is-invalid");
          const feedback = input.parentNode.querySelector(".invalid-feedback");
          if (feedback) {
            feedback.textContent = message;
          }
        }

        function clearValidationErrors() {
          const inputs = [loginInput, passwordInput];
          inputs.forEach((input) => {
            input.classList.remove("is-invalid");
            const feedback =
              input.parentNode.querySelector(".invalid-feedback");
            if (feedback) {
              feedback.textContent = "";
            }
          });
        }
      });
    </script>
  </body>
</html>
